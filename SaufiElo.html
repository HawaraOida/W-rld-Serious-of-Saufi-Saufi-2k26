<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>W√∂rld Serious of Saufi Saufi</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Supabase Bibliothek -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <!-- 3. Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçª</text></svg>">

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 pb-20">

    <!-- Header -->
    <div class="bg-emerald-700 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-3xl mx-auto flex items-start justify-between gap-2">
            <div class="flex items-start gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-yellow-400 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="5.5" cy="8" r="3.5" />
                    <circle cx="12" cy="8" r="3.5" />
                    <circle cx="18.5" cy="8" r="3.5" />
                    <circle cx="8.75" cy="13" r="3.5" />
                    <circle cx="15.25" cy="13" r="3.5" />
                </svg>
                <div>
                    <h1 class="text-lg font-bold leading-tight">W√∂rld Serious of Saufi Saufi - VuiBlattlympics 2k26</h1>
                    <p class="text-[10px] text-emerald-100 leading-snug mt-1 max-w-md opacity-90">
                        Official Megaevent f√ºr olle, de liaba vui blattln statt trainiern.
                    </p>
                </div>
            </div>
            
            <button onclick="app.exportCSV()" class="text-xs bg-emerald-800 hover:bg-emerald-900 px-3 py-2 rounded border border-emerald-600 transition flex flex-col items-center gap-1 shrink-0">
                <span class="text-lg">üì•</span> 
                <span class="hidden sm:inline">Excel</span>
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="max-w-3xl mx-auto mt-4 px-2">
        <div class="flex bg-white rounded-lg shadow p-1 mb-6">
            <button onclick="app.setTab('rank')" id="btn-rank" class="flex-1 py-2 rounded text-sm font-medium transition">Rangliste</button>
            <button onclick="app.setTab('match')" id="btn-match" class="flex-1 py-2 rounded text-sm font-medium transition">Match +</button>
            <button onclick="app.setTab('settings')" id="btn-settings" class="flex-1 py-2 rounded text-sm font-medium transition">Spieler</button>
        </div>

        <!-- Content Container -->
        <div id="app-content" class="fade-in">
            <div class="text-center mt-10 text-slate-500 flex flex-col items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-700 mb-2"></div>
                <p>Verbinde mit Datenbank...</p>
            </div>
        </div>
    </div>

    <script>
        const K_FACTOR = 32;
        const SUPABASE_URL = 'https://tbeupewhdgcyxugxsfjd.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiZXVwZXdoZGdjeXh1Z3hzZmpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NDY4NzIsImV4cCI6MjA3OTMyMjg3Mn0.hqICv1Yy4spdJa6sKZSnDXQL2r0sCHlBg3CL1DE10BU';
        
        let sbClient = null;

        try {
            sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.error("Supabase Init Fehler:", e);
        }

        const app = {
            data: {
                players: [],
                history: [],
                activeTab: 'rank',
                matchInputs: Array(8).fill(''),
                winnerMode: 0,
                // HIER kannst du die Bild-URL f√ºr das Bild unter der History √§ndern
                footerImageUrl: 'https://images.unsplash.com/photo-1597075095400-b210064971da?auto=format&fit=crop&q=80&w=800' 
            },

            init() {
                if (!sbClient) return;
                this.fetchData()
                    .then(() => this.render())
                    .catch((err) => this.renderError(err));
            },

            async fetchData() {
                try {
                    let { data: players, error: playersError } = await sbClient
                        .from('players')
                        .select('*')
                        .order('elo', { ascending: false });

                    if (playersError) throw playersError;

                    let { data: history, error: historyError } = await sbClient
                        .from('history')
                        .select('*')
                        .order('match_id', { ascending: false });
                    
                    if (historyError) throw historyError;

                    this.data.players = players || [];
                    this.data.history = (history || []).map(entry => ({
                        ...entry,
                        ranking: entry.ranking ? entry.ranking.split(',').map(s => s.trim()) : []
                    }));

                    if (this.data.players.length === 0) {
                        this.data.players = Array.from({length: 8}, (_, i) => ({
                            id: 'p' + (i+1),
                            name: 'Saufi ' + (i+1),
                            elo: 1000,
                            matches: 0,
                            wins: 0
                        }));
                        await sbClient.from('players').insert(this.data.players);
                    }
                } catch (error) {
                    console.error("Ladefehler:", error);
                    throw error;
                }
            },

            async saveData(newHistoryEntry) {
                try {
                    await sbClient.from('players').delete().neq('id', 'deleted');
                    const { error: insertPlayersError } = await sbClient.from('players').insert(this.data.players);
                    if (insertPlayersError) throw insertPlayersError;

                    if (newHistoryEntry) {
                        const nextId = this.data.history.length + 1;
                        const { error: insertHistoryError } = await sbClient
                            .from('history')
                            .insert([{
                                match_id: nextId,
                                date: newHistoryEntry.date,
                                mode: newHistoryEntry.mode,
                                ranking: newHistoryEntry.ranking.join(', '),
                                match_name: newHistoryEntry.match_name || ''
                            }]);
                        if (insertHistoryError) throw insertHistoryError;
                    }
                } catch (error) {
                    console.error("Speicherfehler:", error);
                    throw error;
                }
            },

            setTab(tab) {
                this.data.activeTab = tab;
                this.render();
            },

            setWinnerMode(mode) {
                this.data.winnerMode = mode;
                this.render();
            },

            updateMatchInput(index, value) {
                this.data.matchInputs[index] = value;
            },

            updatePlayerName(id, newName) {
                const p = this.data.players.find(pl => pl.id === id);
                if(p) {
                    p.name = newName;
                    this.saveData(null).catch(e => alert("Fehler beim Speichern"));
                }
            },

            getExpectation(ra, rb) {
                return 1 / (1 + Math.pow(10, (rb - ra) / 400));
            },

            async submitMatch() {
                const matchName = document.getElementById('input-match-name')?.value.trim() || '';
                const activeIds = this.data.matchInputs.filter(id => id !== "");

                if (activeIds.length < 2) return alert("Mindestens 2 Spieler n√∂tig!");
                if (new Set(activeIds).size !== activeIds.length) return alert("Spieler doppelt ausgew√§hlt!");

                const eloDeltas = {};
                activeIds.forEach(id => eloDeltas[id] = 0);
                const playersMap = new Map(this.data.players.map(p => [p.id, {...p}]));

                for (let i = 0; i < activeIds.length; i++) {
                    const pA = playersMap.get(activeIds[i]);
                    for (let j = i + 1; j < activeIds.length; j++) {
                        const pB = playersMap.get(activeIds[j]);
                        const expA = this.getExpectation(pA.elo, pB.elo);
                        const expB = this.getExpectation(pB.elo, pA.elo);

                        let scoreA = (this.data.winnerMode === 1) ? (i === 0 ? 1 : 0) : (i < j ? 1 : 0);
                        if (this.data.winnerMode === 1 && i !== 0) continue;

                        eloDeltas[activeIds[i]] += K_FACTOR * (scoreA - expA);
                        eloDeltas[activeIds[j]] += K_FACTOR * ((1-scoreA) - expB);
                    }
                }

                this.data.players = this.data.players.map(p => {
                    if (eloDeltas[p.id] !== undefined) {
                        return {
                            ...p,
                            elo: p.elo + eloDeltas[p.id],
                            matches: p.matches + 1,
                            wins: activeIds[0] === p.id ? p.wins + 1 : p.wins
                        };
                    }
                    return p;
                });

                const newHistoryEntry = {
                    date: new Date().toLocaleString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric', hour: '2-digit', minute: '2-digit' }),
                    mode: this.data.winnerMode,
                    ranking: activeIds,
                    match_name: matchName 
                };

                const btn = document.getElementById('submit-btn');
                if(btn) btn.innerText = "Speichere...";
                
                try {
                    await this.saveData(newHistoryEntry);
                    await this.fetchData();
                    this.data.matchInputs = Array(8).fill('');
                    this.data.activeTab = 'rank';
                    this.render();
                } catch (e) {
                    alert("Fehler beim Speichern!");
                    if(btn) btn.innerText = "Berechnen & Speichern";
                }
            },

            exportCSV() {
                let csv = "RANG,NAME,ELO,SPIELE,SIEGE\n";
                [...this.data.players].sort((a,b) => b.elo - a.elo).forEach((p, i) => {
                    csv += `${i+1},${p.name},${Math.round(p.elo)},${p.matches},${p.wins}\n`;
                });
                csv += "\nMATCH HISTORY\nID,DATUM,MATCH-NAME,MODUS,PLATZIERUNG...\n";
                this.data.history.forEach(m => {
                    const names = m.ranking.map(rid => this.data.players.find(p => p.id === rid)?.name).join(", ");
                    csv += `${m.match_id},${m.date},"${m.match_name || ''}",${m.mode === 1 ? 'WinnerOnly' : 'Ranked'},"${names}"\n`;
                });
                const link = document.createElement("a");
                link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
                link.download = "SaufiSaufi_Export.csv";
                link.click();
            },

            render() {
                const container = document.getElementById('app-content');
                ['rank', 'match', 'settings'].forEach(t => {
                    const btn = document.getElementById(`btn-${t}`);
                    if(btn) btn.className = this.data.activeTab === t 
                        ? "flex-1 py-2 rounded text-sm font-medium transition bg-emerald-100 text-emerald-800 shadow-sm"
                        : "flex-1 py-2 rounded text-sm font-medium transition text-gray-500 hover:bg-gray-50";
                });

                if (this.data.activeTab === 'rank') this.renderRank(container);
                else if (this.data.activeTab === 'match') this.renderMatch(container);
                else if (this.data.activeTab === 'settings') this.renderSettings(container);
            },

            renderRank(container) {
                const sorted = [...this.data.players].sort((a,b) => b.elo - a.elo);
                let html = `<div class="bg-white rounded-lg shadow overflow-hidden mb-6"><table class="w-full text-left">
                    <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                        <tr><th class="p-3">#</th><th class="p-3">Name</th><th class="p-3 text-right">Elo</th></tr>
                    </thead><tbody class="divide-y divide-slate-100">`;
                
                sorted.forEach((p, i) => {
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                    html += `<tr class="${i===0 ? 'bg-yellow-50' : ''}">
                        <td class="p-3 text-slate-400 text-sm font-mono">${i+1}</td>
                        <td class="p-3 font-medium">${p.name} ${medal}</td>
                        <td class="p-3 text-right font-bold text-emerald-600 font-mono">${Math.round(p.elo)}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;

                html += `<h3 class="text-xs font-bold text-slate-400 uppercase mb-3 ml-1">Letzte Matches</h3><div class="space-y-3 mb-8">`;
                
                if(this.data.history.length === 0) {
                    html += `<p class="text-center text-sm text-slate-400 italic py-4">Keine Spiele bisher.</p>`;
                }
                
                this.data.history.forEach(m => {
                    const namesHtml = m.ranking.map((rid, idx) => {
                        const name = this.data.players.find(p => p.id === rid)?.name || '?';
                        const style = idx === 0 ? 'bg-yellow-100 text-yellow-800 border-yellow-200 font-bold' : 'bg-white border-slate-200 text-slate-600';
                        return `<span class="px-2 py-1 rounded text-[10px] border ${style}">${idx+1}. ${name}</span>`;
                    }).join(' ');

                    html += `
                        <div class="bg-white p-3 rounded shadow-sm border-l-4 border-emerald-500">
                            <div class="flex justify-between items-start text-[10px] text-slate-400 mb-1 uppercase tracking-wide">
                                <div>
                                    ${m.match_name ? `<span class="font-bold text-emerald-700 block mb-1 text-xs">"${m.match_name}"</span>` : ''}
                                    <span>Sp√º: ${m.match_id} ‚Ä¢ ${m.date}</span>
                                </div>
                                <span>${m.mode === 1 ? 'Winner Only' : 'Ranked'}</span>
                            </div>
                            <div class="flex flex-wrap gap-1 mt-2">${namesHtml}</div>
                        </div>`;
                });
                
                // DAS BILD UNTER DER HISTORY
                html += `</div>
                    <div class="mt-8 mb-4">
                        <div class="bg-white p-2 rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                            <img src="${this.data.footerImageUrl}" 
                                 alt="Event Bild" 
                                 class="w-full h-auto rounded-md object-cover"
                                 onerror="this.parentElement.style.display='none'">
                            <div class="p-2 text-center">
                                <p class="text-[10px] text-slate-400 italic uppercase tracking-widest">Saufi Saufi 2026 Memorial</p>
                            </div>
                        </div>
                    </div>`;

                container.innerHTML = html;
            },

            renderMatch(container) {
                const isRanked = this.data.winnerMode === 0;
                let html = `
                    <div class="bg-white rounded-lg shadow p-5">
                        <h2 class="font-bold mb-4">Neues Match eintragen</h2>
                        <div class="flex gap-2 mb-6">
                            <button onclick="app.setWinnerMode(0)" class="flex-1 p-2 rounded border text-xs ${isRanked ? 'bg-emerald-600 text-white shadow-inner' : 'bg-slate-50 text-slate-600'}">
                                <strong>Platzierung</strong><br>Alle Pl√§tze z√§hlen
                            </button>
                            <button onclick="app.setWinnerMode(1)" class="flex-1 p-2 rounded border text-xs ${!isRanked ? 'bg-emerald-600 text-white shadow-inner' : 'bg-slate-50 text-slate-600'}">
                                <strong>Winner Only</strong><br>Nur 1. Platz wertet
                            </button>
                        </div>
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Match Name</label>
                            <input type="text" id="input-match-name" class="w-full p-2 border rounded text-sm outline-none focus:border-emerald-500 bg-slate-50" placeholder="z.B. Stammtisch-Runde">
                        </div>
                        <div class="space-y-3 mb-6">`;
                
                for(let i=0; i<8; i++) {
                    let options = `<option value="">-- Leer --</option>`;
                    this.data.players.forEach(p => {
                        const selected = this.data.matchInputs[i] === p.id ? 'selected' : '';
                        options += `<option value="${p.id}" ${selected}>${p.name} (${Math.round(p.elo)})</option>`;
                    });
                    html += `
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${i===0 ? 'bg-yellow-400 text-yellow-900' : 'bg-slate-200 text-slate-500'}">${i+1}</div>
                            <select onchange="app.updateMatchInput(${i}, this.value)" class="flex-1 p-2 border rounded bg-slate-50 text-sm outline-none focus:border-emerald-500">
                                ${options}
                            </select>
                        </div>`;
                }
                container.innerHTML = html + `</div><button id="submit-btn" onclick="app.submitMatch()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded transition shadow">Berechnen & Speichern</button></div>`;
            },

            renderSettings(container) {
                let html = `
                    <div class="bg-white rounded-lg shadow p-5">
                        <h2 class="font-bold mb-4">Einstellungen</h2>
                        
                        <div class="mb-8">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Spieler Namen</label>
                            <div class="space-y-3">`;
                
                this.data.players.forEach((p, i) => {
                    html += `<div class="flex items-center gap-2">
                        <span class="text-xs text-slate-400 w-4">${i+1}</span>
                        <input type="text" value="${p.name}" onchange="app.updatePlayerName('${p.id}', this.value)" class="flex-1 p-2 border rounded text-sm focus:border-emerald-500 outline-none">
                    </div>`;
                });
                
                html += `</div></div>
                        
                        <div class="border-t pt-4">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Footer Bild URL</label>
                            <input type="text" value="${this.data.footerImageUrl}" 
                                   onchange="app.data.footerImageUrl = this.value; app.render();" 
                                   class="w-full p-2 border rounded text-sm focus:border-emerald-500 outline-none bg-slate-50"
                                   placeholder="Bild URL hier einf√ºgen...">
                            <p class="text-[10px] text-slate-400 mt-1">F√ºge hier den Link zu einem Bild ein, das unter der Rangliste erscheinen soll.</p>
                        </div>

                        <div class="border-t pt-4 mt-8 text-center">
                            <button onclick="app.resetData()" class="text-red-500 text-xs hover:underline">‚ö†Ô∏è Datenbank zur√ºcksetzen</button>
                        </div>
                    </div>`;
                container.innerHTML = html;
            },

            async resetData() {
                if(confirm("Alle Daten unwiderruflich l√∂schen?")) {
                    await sbClient.from('players').delete().neq('id', 'deleted');
                    await sbClient.from('history').delete().neq('match_id', 0);
                    location.reload();
                }
            },
            
            renderError(err) {
                document.getElementById('app-content').innerHTML = `<div class="p-5 bg-red-50 text-red-700 rounded-lg text-center">Fehler: ${err.message}</div>`;
            }
        };

        app.init();
    </script>
</body>
</html>
